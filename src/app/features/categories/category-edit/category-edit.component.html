<div class="main-content p-4">
  <div class="card shadow-sm">
    <div class="card-body p-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">Edit Category</h4>
      </div>

      <!-- Form -->
      <form [formGroup]="editCategoryForm" (ngSubmit)="onSubmit()">
        <div class="row g-4">
          <!-- Image Upload -->
          <div class="col-md-6">
            <label for="image" class="form-label">Image</label>
            <input
              type="file"
              id="image"
              (change)="onFileSelected($event)"
              class="form-control"
            />
            <div *ngIf="imagePreviewUrl" class="mt-2">
              <img
                [src]="imagePreviewUrl"
                alt="Preview"
                class="img-thumbnail"
                style="max-height: 200px"
              />
            </div>
          </div>

          <!-- Category Name -->
          <div class="col-md-6">
            <label for="categoryName" class="form-label">Category Name</label>
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="bi bi-folder"></i>
              </span>
              <input
                type="text"
                id="categoryName"
                class="form-control"
                formControlName="name"
                placeholder="Enter category name"
                autocomplete="off"
              />
            </div>
            <div
              *ngIf="
                editCategoryForm.get('name')?.invalid &&
                editCategoryForm.get('name')?.touched
              "
              class="text-danger mt-1"
            >
              <small *ngIf="editCategoryForm.get('name')?.errors?.['required']">
                Category name is required.
              </small>
              <small
                *ngIf="editCategoryForm.get('name')?.errors?.['minlength']"
              >
                Category name must be at least 3 characters.
              </small>
            </div>
          </div>
        </div>

        <!-- Parent Category Selection -->
        <div class="mt-4">
          <label class="form-label">Parent Category</label>

          <!-- Info Section -->
          <div class="alert alert-info small" role="alert">
            <strong>Parent Category Rules:</strong>
            <ul class="mb-0 ps-3">
              <li>
                This category cannot be assigned under itself or its
                descendants.
              </li>
              <li>
                Categories that already contain <strong>products</strong> cannot
                be selected.
              </li>
              <li>
                Each category shows how many <strong>subcategories</strong> and
                <strong>products</strong> it contains.
              </li>
              <li>
                Select <em>No Parent</em> to move this category to the top
                level.
              </li>
            </ul>
          </div>

          <div
            class="border rounded p-3 bg-light"
            style="max-height: 400px; overflow-y: auto"
          >
            <!-- No Parent Option -->
            <div class="form-check mb-2">
              <input
                class="form-check-input"
                type="radio"
                name="parentCategory"
                [value]="null"
                (change)="onParentSelected(null)"
                [checked]="!editCategoryForm.value.parentCategoryId"
                id="noParent"
              />
              <label class="form-check-label" for="noParent">
                <i class="bi bi-slash-circle me-1 text-muted"></i>
                No Parent (Top-Level Category)
              </label>
            </div>

            <!-- Recursive Tree Rendering -->
            <ng-container *ngFor="let category of validParentTree">
              <ng-template
                [ngTemplateOutlet]="renderTree"
                [ngTemplateOutletContext]="{ $implicit: category, level: 0 }"
              ></ng-template>
            </ng-container>

            <!-- Recursive Tree Template -->
            <ng-template #renderTree let-node let-level="level">
              <div [ngStyle]="{ 'margin-left.px': level * 20 }" class="mb-1">
                <div class="d-flex align-items-center gap-2">
                  <!-- Expand/Collapse caret -->
                  <span
                    *ngIf="node.children?.length"
                    class="cursor-pointer"
                    (click)="toggleNode(node)"
                    style="width: 16px"
                  >
                    <i
                      class="bi"
                      [ngClass]="{
                        'bi-caret-right': !isExpanded(node),
                        'bi-caret-down': isExpanded(node)
                      }"
                    ></i>
                  </span>
                  <span
                    *ngIf="!node.children?.length"
                    style="width: 16px"
                  ></span>

                  <!-- Radio + label -->
                  <div class="form-check d-flex align-items-center gap-2">
                    <input
                      class="form-check-input mt-0"
                      type="radio"
                      name="parentCategory"
                      [value]="node.id"
                      (change)="onParentSelected(node.id)"
                      [checked]="
                        node.id === editCategoryForm.value.parentCategoryId
                      "
                      [id]="node.id"
                      [disabled]="node.productCount > 0"
                    />
                    <label
                      class="form-check-label d-flex align-items-center gap-2"
                      [for]="node.id"
                    >
                      <i class="bi bi-folder2-open text-warning"></i>
                      {{ node.name }}
                      <small class="text-muted">
                        ({{ node.subcategoryCount }} sub,
                        {{ node.productCount }} prod)
                      </small>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Children -->
              <div *ngIf="isExpanded(node)">
                <ng-container *ngFor="let child of node.children">
                  <ng-template
                    [ngTemplateOutlet]="renderTree"
                    [ngTemplateOutletContext]="{
                      $implicit: child,
                      level: level + 1
                    }"
                  ></ng-template>
                </ng-container>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end mt-4 gap-2">
          <button
            class="btn btn-outline-secondary"
            type="button"
            [routerLink]="['/categories']"
          >
            <i class="bi bi-x-lg me-2"></i> Cancel
          </button>
          <button
            class="btn btn-primary"
            type="submit"
            [disabled]="editCategoryForm.invalid || isSubmitting"
          >
            <i class="bi bi-check-lg me-2"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
